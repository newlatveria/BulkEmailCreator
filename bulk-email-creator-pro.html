<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Creator Pro - Enhanced Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        /* Comprehensive overflow prevention */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            max-width: 100vw;
            width: 100%;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            max-width: 100vw;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Prevent any element from causing horizontal scroll */
        * {
            max-width: 100%;
        }
        
        img,
        svg,
        video,
        canvas,
        audio,
        iframe,
        embed,
        object {
            max-width: 100%;
            height: auto;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Custom gray-750 color */
        .bg-gray-750 {
            background-color: #2d3748;
        }
        
        /* Draggable help panel styles */
        .help-panel {
            position: fixed;
            width: 400px;
            max-height: 80vh;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 200px;
            max-width: 90vw;
        }
        
        .help-panel-header {
            cursor: move;
            user-select: none;
        }
        
        /* Multi-select chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #14b8a6;
            color: white;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin: 2px;
        }
        
        .chip button {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 12px;
            line-height: 1;
        }
        
        .chip button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .chip.invalid {
            background: #dc2626;
        }
        
        /* Desktop grid layout - Enhanced for accessibility */
        .desktop-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(300px, 400px);
            gap: 1.5rem;
            align-items: start;
            max-width: 100%;
            width: 100%;
        }
        
        @media (max-width: 1400px) {
            .desktop-grid {
                grid-template-columns: minmax(0, 1fr) minmax(280px, 350px);
                gap: 1rem;
            }
        }
        
        @media (max-width: 1280px) {
            .desktop-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .desktop-grid {
                gap: 0.75rem;
            }
            
            /* Force all cards to full width on mobile */
            .bg-gray-800 {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Reduce padding on mobile to prevent overflow */
            .p-6 {
                padding: 1rem !important;
            }
            
            /* Make text smaller on mobile */
            .text-4xl {
                font-size: 1.5rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.5rem !important;
            }
            
            .desktop-grid {
                gap: 0.5rem;
            }
            
            .rounded-xl {
                border-radius: 0.5rem;
            }
        }

        /* Ensure grid children don't overflow */
        .desktop-grid > * {
            min-width: 0;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Sticky sidebar for better UX */
        .sticky-sidebar {
            position: sticky;
            top: 1.5rem;
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
            max-width: 100%;
            min-width: 0;
        }

        /* Improved focus states for accessibility */
        button:focus-visible, 
        input:focus-visible, 
        select:focus-visible, 
        textarea:focus-visible {
            outline: 2px solid #14b8a6;
            outline-offset: 2px;
        }

        /* Prevent overflow in all containers */
        .space-y-6 > *,
        .space-y-4 > * {
            max-width: 100%;
            overflow-x: hidden;
            min-width: 0;
        }

        /* Ensure all cards don't overflow */
        .bg-gray-800 {
            max-width: 100%;
            overflow-x: hidden;
            width: 100%;
        }

        .rounded-xl {
            max-width: 100%;
        }

        /* Table container constraints */
        #previewTableContainer {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Table cell constraints to prevent overflow */
        #dataPreviewTable th,
        #dataPreviewTable td {
            max-width: 250px;
            min-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Expand on hover for full content */
        #dataPreviewTable td:hover {
            overflow: visible;
            white-space: normal;
            position: relative;
            z-index: 10;
            background: #374151;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Email links container - prevent overflow */
        #emailLinksContainer {
            max-width: 100%;
            word-break: break-word;
        }

        /* Variable tags responsive */
        #headerTags {
            max-width: 100%;
        }

        /* Ensure form inputs don't cause overflow */
        input[type="text"],
        input[type="email"],
        textarea,
        select {
            max-width: 100%;
            width: 100%;
        }

        /* Grid layouts should respect container width */
        .grid {
            width: 100%;
            max-width: 100%;
        }

        /* Flex containers should wrap and not overflow */
        .flex {
            max-width: 100%;
        }

        .flex-grow,
        .flex-1 {
            min-width: 0;
        }

        /* Specific fix for file input */
        input[type="file"] {
            max-width: 100%;
            overflow: hidden;
        }

        /* Skip to content link for screen readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #14b8a6;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }
        
        /* Variable usage panel */
        .variable-badge {
            display: inline-block;
            background: #1e293b;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 2px;
            font-family: 'Courier New', monospace;
        }
        
        .variable-badge.used {
            background: #14532d;
            color: #86efac;
        }

        /* Scrollable table container hint */
        .table-scroll-hint {
            position: relative;
        }

        .table-scroll-hint::after {
            content: "‚Üê Scroll ‚Üí";
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(20, 184, 166, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .table-scroll-hint.show-hint::after {
            opacity: 1;
        }

        /* Progress bar */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #14b8a6, #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 9999;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 9999;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: #059669;
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.info {
            background: #3b82f6;
        }

        /* Email validation */
        .email-invalid {
            border: 2px solid #dc2626 !important;
        }

        .email-valid {
            border: 2px solid #059669 !important;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #14b8a6;
            width: 20px;
            height: 20px;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Template card */
        .template-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Keyboard shortcut indicator */
        .kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 3px;
            margin-left: 8px;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 antialiased leading-relaxed p-2 sm:p-4 md:p-6">

    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Progress Bar -->
    <div id="progressBar" class="progress-bar"></div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Draggable Help Panel -->
    <div id="helpPanel" class="help-panel hidden bg-gray-800 rounded-xl z-50 border border-gray-700">
        <div id="helpPanelHeader" class="help-panel-header bg-gray-900 rounded-t-xl p-4 border-b border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold text-teal-400">üìñ Help & Guide</h2>
            <button id="closeHelpPanel" class="p-1 hover:bg-gray-700 rounded transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(80vh - 60px);">
            <div class="space-y-4 text-sm text-gray-300">
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">‚å®Ô∏è Keyboard Shortcuts</h3>
                    <ul class="text-xs space-y-1">
                        <li><kbd class="kbd">Ctrl/Cmd + G</kbd> - Generate emails</li>
                        <li><kbd class="kbd">Ctrl/Cmd + P</kbd> - Preview first email</li>
                        <li><kbd class="kbd">Ctrl/Cmd + S</kbd> - Save template</li>
                        <li><kbd class="kbd">Ctrl/Cmd + Z</kbd> - Undo last clear</li>
                        <li><kbd class="kbd">?</kbd> - Toggle help panel</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üìÅ File Format</h3>
                    <p>Upload a CSV or Excel file (.xlsx, .xls) with headers in the first row and data in subsequent rows.</p>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üè∑Ô∏è Using Variables</h3>
                    <p>Click any header tag to copy it, then paste into your subject or body. Example: <code class="bg-gray-700 px-1 rounded">{{Name}}</code> will be replaced with each person's name.</p>
                    <p class="mt-2 text-xs text-gray-400">Check the "Variables Used" panel to see which variables are in your template.</p>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">‚úÖ Email Validation</h3>
                    <p>Email addresses are validated in real-time. Invalid emails will be highlighted in red.</p>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üìß CC & BCC Options</h3>
                    <p>You have two ways to add CC/BCC recipients:</p>
                    <ul class="list-disc list-inside mt-2 text-xs space-y-1">
                        <li><strong>From Spreadsheet:</strong> Select a column that contains CC/BCC emails (different per row)</li>
                        <li><strong>Manual Entry:</strong> Type emails to add to ALL generated emails</li>
                        <li>Both can be used together - they will be combined</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üíæ Templates</h3>
                    <p>Save your email templates for reuse. Templates include subject, body, and settings.</p>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üîÑ Merge Features</h3>
                    <p>Three merge modes available:</p>
                    <ul class="list-disc list-inside mt-2 text-xs space-y-1">
                        <li><strong>No merging:</strong> One email per row (default)</li>
                        <li><strong>Merge same recipient:</strong> Combine rows with same email into numbered sections</li>
                        <li><strong>Multi-recipient:</strong> All recipients in one email with shared body text - choose TO (visible to all) or BCC (hidden from each other)</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üìß Sending Emails</h3>
                    <p>Click any generated link to open a draft in your default email client. The link contains all recipients, subject, and body text.</p>
                </div>
                <div>
                    <h3 class="font-bold text-teal-300 mb-2">üí° Pro Tips</h3>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>Drag this help panel anywhere on screen</li>
                        <li>Resize the panel from the bottom-right corner</li>
                        <li>Use Ctrl+Z to undo clearing emails</li>
                        <li>Export to CSV or TXT format</li>
                        <li>Save templates for commonly used email formats</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Selector Modal -->
    <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-teal-400">üìù Saved Templates</h2>
                <button id="closeTemplateModal" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="templateList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Templates will be inserted here -->
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto px-2 sm:px-4 w-full" style="max-width: min(1600px, 100vw);">
        <!-- Header -->
        <div class="bg-gray-800 rounded-xl shadow-2xl p-4 md:p-6 mb-4 md:mb-6 w-full">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div class="min-w-0 flex-1">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-teal-400 truncate">Bulk Email Creator Pro</h1>
                    <p class="text-xs sm:text-sm text-gray-400 mt-1">Enhanced Edition - Generate personalized email drafts with advanced features</p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button id="undoBtn" class="p-3 bg-amber-600 hover:bg-amber-500 rounded-lg transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Undo last clear (Ctrl+Z)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                        </svg>
                    </button>
                    <button id="helpBtn" class="p-3 bg-teal-600 hover:bg-teal-500 rounded-lg transition-colors shadow-lg" title="Help (Press ?)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Desktop Grid Layout -->
        <div class="desktop-grid" id="main-content">
            <!-- Left Column - Main Content -->
            <div class="space-y-6">
                <!-- File Upload Card -->
                <div class="bg-gray-800 rounded-xl shadow-xl p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-bold text-teal-300 mb-4">üìÅ Data Source</h2>
                    <div>
                        <label for="csvFile" class="block text-sm font-medium text-gray-300 mb-2">Upload your file</label>
                        <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                            <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" class="flex-grow text-sm text-gray-400
                                file:mr-4 file:py-2.5 file:px-6
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-teal-500 file:text-white
                                hover:file:bg-teal-600 transition-colors duration-200 cursor-pointer
                                max-w-full overflow-hidden">
                            <span class="text-xs text-gray-500 font-mono text-center sm:text-left">CSV, XLSX, XLS</span>
                        </div>
                    </div>

                    <!-- Data Preview Section -->
                    <div id="preview-section" class="hidden mt-6">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-300">üìä Data Preview</label>
                            <span id="rowCount" class="text-xs text-gray-400"></span>
                        </div>
                        <div id="previewTableContainer" class="table-scroll-hint bg-gray-700 rounded-lg p-3 overflow-x-auto custom-scrollbar max-h-48">
                            <table id="dataPreviewTable" class="text-xs min-w-full table-auto">
                                <thead id="previewTableHead"></thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">üí° Table scrolls horizontally if you have many columns</p>
                    </div>
                </div>

                <!-- Available Headers -->
                <div id="headers-section" class="hidden bg-gray-800 rounded-xl shadow-xl p-4 md:p-6 overflow-hidden">
                    <h2 class="text-lg md:text-xl font-bold text-teal-300 mb-4">üè∑Ô∏è Available Variables</h2>
                    <p class="text-xs text-gray-400 mb-3">Click any variable to copy it to your clipboard</p>
                    <div id="headerTags" class="flex flex-wrap gap-2 p-4 bg-gray-700 rounded-lg max-h-60 overflow-y-auto custom-scrollbar max-w-full">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">üí° Scroll if you have many columns</p>
                </div>

                <!-- Email Configuration -->
                <div class="bg-gray-800 rounded-xl shadow-xl p-4 md:p-6 overflow-hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                        <h2 class="text-lg md:text-xl font-bold text-teal-300">‚öôÔ∏è Email Configuration</h2>
                        <div class="flex flex-wrap gap-2">
                            <button id="loadTemplateBtn" class="text-sm bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors font-semibold">
                                üìÇ Load Template
                            </button>
                            <button id="saveTemplateBtn" class="text-sm bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg transition-colors font-semibold" title="Save template (Ctrl+S)">
                                üíæ Save Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                            <div class="min-w-0">
                                <label for="recipientColumn" class="block text-sm font-medium text-gray-300 mb-2">Recipient Column *</label>
                                <select id="recipientColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
                            </div>
                            <div class="min-w-0">
                                <label for="nameColumn" class="block text-sm font-medium text-gray-300 mb-2">Name Column</label>
                                <select id="nameColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">None</option>
                                </select>
                            </div>
                        </div>

                        <!-- CC Options -->
                        <div class="border border-gray-700 rounded-lg p-4 bg-gray-750">
                            <h3 class="text-sm font-semibold text-teal-300 mb-3">CC Recipients (Optional)</h3>
                            
                            <!-- CC from spreadsheet column -->
                            <div class="mb-3">
                                <label for="ccColumn" class="block text-xs font-medium text-gray-400 mb-2">üìä CC from spreadsheet column:</label>
                                <select id="ccColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">None</option>
                                </select>
                            </div>
                            
                            <!-- Manual CC recipients -->
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-2">‚úçÔ∏è Manual CC (added to all emails):</label>
                                <div class="bg-gray-700 rounded-lg p-3 min-h-[50px]">
                                    <div id="ccChipsContainer" class="mb-2"></div>
                                    <input type="text" id="ccInput" placeholder="Type email and press Enter..." 
                                        class="w-full bg-transparent text-gray-100 text-sm focus:outline-none placeholder-gray-500">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Press Enter, comma, or space to add multiple recipients</p>
                            </div>
                        </div>

                        <!-- BCC Options -->
                        <div class="border border-gray-700 rounded-lg p-4 bg-gray-750">
                            <h3 class="text-sm font-semibold text-teal-300 mb-3">BCC Recipients (Optional)</h3>
                            
                            <!-- BCC from spreadsheet column -->
                            <div class="mb-3">
                                <label for="bccColumn" class="block text-xs font-medium text-gray-400 mb-2">üìä BCC from spreadsheet column:</label>
                                <select id="bccColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">None</option>
                                </select>
                            </div>
                            
                            <!-- Manual BCC recipients -->
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-2">‚úçÔ∏è Manual BCC (added to all emails):</label>
                                <div class="bg-gray-700 rounded-lg p-3 min-h-[50px]">
                                    <div id="bccChipsContainer" class="mb-2"></div>
                                    <input type="text" id="bccInput" placeholder="Type email and press Enter..." 
                                        class="w-full bg-transparent text-gray-100 text-sm focus:outline-none placeholder-gray-500">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Press Enter, comma, or space to add multiple recipients</p>
                            </div>
                        </div>
                        
                        <div>
                            <label for="subjectTemplate" class="block text-sm font-medium text-gray-300 mb-2">Email Subject *</label>
                            <input type="text" id="subjectTemplate" placeholder="e.g., Your monthly update from {{Company}}" 
                                class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>

                        <div>
                            <label for="bodyTemplate" class="block text-sm font-medium text-gray-300 mb-2">Email Body *</label>
                            <textarea id="bodyTemplate" rows="10" placeholder="e.g., Dear {{Name}},&#10;&#10;Your account number {{AccountNumber}} is now ready.&#10;&#10;Best regards,&#10;The Team" 
                                class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 font-mono text-sm"></textarea>
                            <div class="flex gap-2 mt-2">
                                <button id="insertGreetingBtn" class="text-xs bg-gray-600 hover:bg-gray-500 text-white px-3 py-1.5 rounded-lg transition-colors">
                                    Insert Greeting
                                </button>
                                <button id="insertSignatureBtn" class="text-xs bg-gray-600 hover:bg-gray-500 text-white px-3 py-1.5 rounded-lg transition-colors">
                                    Insert Signature
                                </button>
                            </div>
                        </div>

                        <div>
                            <label for="attachmentsColumn" class="block text-sm font-medium text-gray-300 mb-2">Attachments Column</label>
                            <select id="attachmentsColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="">None</option>
                            </select>
                        </div>

                        <!-- Merge Options -->
                        <div class="border border-gray-700 rounded-lg p-4 bg-gray-750">
                            <h3 class="text-sm font-semibold text-teal-300 mb-3">Merge Options</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3">
                                    <input type="radio" id="mergeNone" name="mergeMode" value="none" class="mt-1 h-4 w-4 border-gray-600 bg-gray-800 text-teal-500 focus:ring-2 focus:ring-teal-500" checked>
                                    <label for="mergeNone" class="text-sm text-gray-300">
                                        <span class="font-semibold">No merging</span>
                                        <span class="block text-xs text-gray-400 mt-1">One email per row</span>
                                    </label>
                                </div>

                                <div class="flex items-start space-x-3">
                                    <input type="radio" id="mergeSameRecipient" name="mergeMode" value="sameRecipient" class="mt-1 h-4 w-4 border-gray-600 bg-gray-800 text-teal-500 focus:ring-2 focus:ring-teal-500">
                                    <label for="mergeSameRecipient" class="text-sm text-gray-300">
                                        <span class="font-semibold">Merge rows with same recipient</span>
                                        <span class="block text-xs text-gray-400 mt-1">Combine multiple rows for same recipient into numbered sections</span>
                                    </label>
                                </div>

                                <!-- Same Recipient Merge Options -->
                                <div id="sameRecipientOptions" class="hidden ml-7 mt-2 p-3 bg-gray-700 rounded border-l-2 border-amber-500">
                                    <label class="block text-xs font-medium text-gray-400 mb-3">Merge format settings:</label>
                                    
                                    <div class="space-y-3">
                                        <!-- Separator Style -->
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-2">Entry separator:</label>
                                            <select id="mergeSeparatorStyle" class="w-full p-2 rounded bg-gray-600 text-gray-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500">
                                                <option value="numbered">--- Entry 1 ---</option>
                                                <option value="bullets">‚Ä¢ Item 1</option>
                                                <option value="headers">== ENTRY 1 ==</option>
                                                <option value="simple">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                                <option value="none">No separator</option>
                                            </select>
                                        </div>

                                        <!-- Include Entry Headers -->
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox" id="includeEntryNumber" class="h-3 w-3 rounded border-gray-600 bg-gray-800 text-teal-500 focus:ring-1 focus:ring-teal-500" checked>
                                            <label for="includeEntryNumber" class="text-xs text-gray-300">Include entry numbers</label>
                                        </div>

                                        <!-- Add summary at top -->
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox" id="addMergeSummary" class="h-3 w-3 rounded border-gray-600 bg-gray-800 text-teal-500 focus:ring-1 focus:ring-teal-500">
                                            <label for="addMergeSummary" class="text-xs text-gray-300">Add summary at top (e.g., "3 items below")</label>
                                        </div>

                                        <!-- Spacing between entries -->
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-2">Spacing between entries:</label>
                                            <select id="mergeSpacing" class="w-full p-2 rounded bg-gray-600 text-gray-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500">
                                                <option value="single">Single line break</option>
                                                <option value="double" selected>Double line break</option>
                                                <option value="triple">Triple line break</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3">
                                    <input type="radio" id="mergeMultiRecipient" name="mergeMode" value="multiRecipient" class="mt-1 h-4 w-4 border-gray-600 bg-gray-800 text-teal-500 focus:ring-2 focus:ring-teal-500">
                                    <label for="mergeMultiRecipient" class="text-sm text-gray-300">
                                        <span class="font-semibold">Combine multiple recipients (shared body)</span>
                                        <span class="block text-xs text-gray-400 mt-1">One email with all recipients in TO/CC field, single body text</span>
                                    </label>
                                </div>

                                <div id="multiRecipientOptions" class="hidden ml-7 mt-2 p-3 bg-gray-700 rounded border-l-2 border-teal-500">
                                    <label class="block text-xs font-medium text-gray-400 mb-2">Where to place additional recipients:</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" id="multiRecipientTo" name="multiRecipientField" value="to" class="h-3 w-3 border-gray-600 bg-gray-800 text-teal-500 focus:ring-1 focus:ring-teal-500" checked>
                                            <label for="multiRecipientTo" class="text-xs text-gray-300">TO field (all visible to each other)</label>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" id="multiRecipientBcc" name="multiRecipientField" value="bcc" class="h-3 w-3 border-gray-600 bg-gray-800 text-teal-500 focus:ring-1 focus:ring-teal-500">
                                            <label for="multiRecipientBcc" class="text-xs text-gray-300">BCC field (hidden from each other)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div id="filter-section" class="hidden bg-gray-800 rounded-xl shadow-xl p-4 md:p-6 overflow-hidden">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
                        <h2 class="text-lg md:text-xl font-bold text-teal-300">üîç Data Filters</h2>
                        <button id="addFilterBtn" class="text-xs md:text-sm bg-teal-600 hover:bg-teal-500 text-white px-3 md:px-4 py-2 rounded-lg transition-colors font-semibold whitespace-nowrap">
                            + Add Filter
                        </button>
                    </div>
                    <div id="filterContainer" class="space-y-3 max-w-full overflow-x-hidden">
                    </div>
                    <div id="filterStats" class="mt-4 text-xs md:text-sm text-teal-400 font-semibold hidden"></div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-gray-800 rounded-xl shadow-xl p-4 md:p-6 overflow-hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                        <button id="previewBtn" class="py-3 md:py-4 px-4 md:px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-800 text-sm md:text-lg">
                            üëÅÔ∏è Preview First Email
                        </button>
                        <button id="generateBtn" class="py-3 md:py-4 px-4 md:px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800 text-sm md:text-lg flex items-center justify-center gap-2">
                            <span>‚úâÔ∏è Generate All Drafts</span>
                            <span id="generateSpinner" class="spinner hidden"></span>
                        </button>
                    </div>

                    <!-- Export Options -->
                    <div id="export-section" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4 mt-3 md:mt-4">
                        <button id="exportMailtoBtn" class="py-2 px-3 md:px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors text-xs md:text-sm whitespace-nowrap">
                            üíæ Export TXT
                        </button>
                        <button id="exportCsvBtn" class="py-2 px-3 md:px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors text-xs md:text-sm whitespace-nowrap">
                            üìä Export CSV
                        </button>
                        <button id="clearAllBtn" class="py-2 px-3 md:px-4 bg-red-900 hover:bg-red-800 text-white rounded-lg transition-colors text-xs md:text-sm whitespace-nowrap">
                            üóëÔ∏è Clear All
                        </button>
                    </div>
                </div>

                <!-- Status Message -->
                <div id="statusMessage" class="text-center text-sm font-semibold transition-opacity duration-300 opacity-0"></div>
                
                <!-- Email Links Container -->
                <div id="emailLinksContainer" class="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar">
                </div>
            </div>

            <!-- Right Column - Variable Usage & Info (Sticky) -->
            <div class="sticky-sidebar space-y-6" role="complementary" aria-label="Template analysis and statistics">
                <!-- Variables Used Panel -->
                <div id="variables-used-panel" class="bg-gray-800 rounded-xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-teal-300 mb-4">üìã Template Analysis</h2>
                    
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Variables in Subject:</h3>
                        <div id="subjectVarsDisplay" class="min-h-[40px] bg-gray-700 rounded p-3 text-xs">
                            <span class="text-gray-500 italic">No variables detected</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Variables in Body:</h3>
                        <div id="bodyVarsDisplay" class="min-h-[60px] bg-gray-700 rounded p-3 text-xs max-h-48 overflow-y-auto custom-scrollbar">
                            <span class="text-gray-500 italic">No variables detected</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-700 pt-4">
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">All Available Columns:</h3>
                        <div id="allColumnsDisplay" class="bg-gray-700 rounded p-3 text-xs max-h-48 overflow-y-auto custom-scrollbar">
                            <span class="text-gray-500 italic">Upload a file to see columns</span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-gray-900 rounded-lg text-xs">
                        <p class="text-gray-400">
                            üí° <span class="font-semibold text-teal-400">Tip:</span> Green badges = used in template, Gray badges = available but unused
                        </p>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div id="stats-panel" class="hidden bg-gray-800 rounded-xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-teal-300 mb-4">üìä Statistics</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Total Rows:</span>
                            <span id="stat-total-rows" class="font-bold text-teal-300">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">After Filters:</span>
                            <span id="stat-filtered-rows" class="font-bold text-teal-300">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Invalid Emails:</span>
                            <span id="stat-invalid-emails" class="font-bold text-red-400">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Variables Used:</span>
                            <span id="stat-vars-used" class="font-bold text-teal-300">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Emails Generated:</span>
                            <span id="stat-emails-gen" class="font-bold text-teal-300">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-teal-400">üìß Email Preview</h2>
                <button id="closePreviewBtn" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="previewContent" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400">TO:</label>
                    <p id="previewTo" class="text-sm text-gray-200 bg-gray-700 p-3 rounded mt-1"></p>
                </div>
                <div id="previewCcSection" class="hidden">
                    <label class="text-xs font-bold text-gray-400">CC:</label>
                    <p id="previewCc" class="text-sm text-gray-200 bg-gray-700 p-3 rounded mt-1"></p>
                </div>
                <div id="previewBccSection" class="hidden">
                    <label class="text-xs font-bold text-gray-400">BCC:</label>
                    <p id="previewBcc" class="text-sm text-gray-200 bg-gray-700 p-3 rounded mt-1"></p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400">SUBJECT:</label>
                    <p id="previewSubject" class="text-sm text-gray-200 bg-gray-700 p-3 rounded mt-1"></p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400">BODY:</label>
                    <pre id="previewBody" class="text-sm text-gray-200 bg-gray-700 p-3 rounded mt-1 whitespace-pre-wrap font-sans"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element references
            const csvFileEl = document.getElementById('csvFile');
            const headersSectionEl = document.getElementById('headers-section');
            const headerTagsEl = document.getElementById('headerTags');
            const previewSectionEl = document.getElementById('preview-section');
            const previewTableHeadEl = document.getElementById('previewTableHead');
            const previewTableBodyEl = document.getElementById('previewTableBody');
            const rowCountEl = document.getElementById('rowCount');
            const recipientColEl = document.getElementById('recipientColumn');
            const nameColEl = document.getElementById('nameColumn');
            const subjectTemplateEl = document.getElementById('subjectTemplate');
            const bodyTemplateEl = document.getElementById('bodyTemplate');
            const ccColEl = document.getElementById('ccColumn');
            const bccColEl = document.getElementById('bccColumn');
            const attachmentsColEl = document.getElementById('attachmentsColumn');
            const mergeNoneEl = document.getElementById('mergeNone');
            const mergeSameRecipientEl = document.getElementById('mergeSameRecipient');
            const mergeMultiRecipientEl = document.getElementById('mergeMultiRecipient');
            const sameRecipientOptions = document.getElementById('sameRecipientOptions');
            const multiRecipientOptions = document.getElementById('multiRecipientOptions');
            const multiRecipientToEl = document.getElementById('multiRecipientTo');
            const multiRecipientBccEl = document.getElementById('multiRecipientBcc');
            const mergeSeparatorStyleEl = document.getElementById('mergeSeparatorStyle');
            const includeEntryNumberEl = document.getElementById('includeEntryNumber');
            const addMergeSummaryEl = document.getElementById('addMergeSummary');
            const mergeSpacingEl = document.getElementById('mergeSpacing');
            const generateBtn = document.getElementById('generateBtn');
            const generateSpinner = document.getElementById('generateSpinner');
            const previewBtn = document.getElementById('previewBtn');
            const statusMessageEl = document.getElementById('statusMessage');
            const linksContainerEl = document.getElementById('emailLinksContainer');
            const helpBtn = document.getElementById('helpBtn');
            const helpPanel = document.getElementById('helpPanel');
            const closeHelpPanel = document.getElementById('closeHelpPanel');
            const helpPanelHeader = document.getElementById('helpPanelHeader');
            const previewModal = document.getElementById('previewModal');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const insertGreetingBtn = document.getElementById('insertGreetingBtn');
            const insertSignatureBtn = document.getElementById('insertSignatureBtn');
            const filterSection = document.getElementById('filter-section');
            const addFilterBtn = document.getElementById('addFilterBtn');
            const filterContainer = document.getElementById('filterContainer');
            const filterStats = document.getElementById('filterStats');
            const exportSection = document.getElementById('export-section');
            const exportMailtoBtn = document.getElementById('exportMailtoBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const statsPanel = document.getElementById('stats-panel');
            const undoBtn = document.getElementById('undoBtn');
            const saveTemplateBtn = document.getElementById('saveTemplateBtn');
            const loadTemplateBtn = document.getElementById('loadTemplateBtn');
            const templateModal = document.getElementById('templateModal');
            const closeTemplateModal = document.getElementById('closeTemplateModal');
            const templateList = document.getElementById('templateList');
            const progressBar = document.getElementById('progressBar');
            const toastContainer = document.getElementById('toastContainer');
            
            // CC/BCC elements
            const ccInput = document.getElementById('ccInput');
            const bccInput = document.getElementById('bccInput');
            const ccChipsContainer = document.getElementById('ccChipsContainer');
            const bccChipsContainer = document.getElementById('bccChipsContainer');
            
            // Variable display elements
            const subjectVarsDisplay = document.getElementById('subjectVarsDisplay');
            const bodyVarsDisplay = document.getElementById('bodyVarsDisplay');
            const allColumnsDisplay = document.getElementById('allColumnsDisplay');

            let csvData = null;
            let csvDataHeaders = [];
            let filters = [];
            let generatedEmails = [];
            let ccEmails = [];
            let bccEmails = [];
            let undoStack = [];

            // Toast notification system
            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            // Progress bar
            const showProgress = (show = true) => {
                if (show) {
                    progressBar.style.transform = 'scaleX(1)';
                } else {
                    setTimeout(() => {
                        progressBar.style.transform = 'scaleX(0)';
                    }, 300);
                }
            };

            const showStatus = (message, isError = false) => {
                statusMessageEl.textContent = message;
                statusMessageEl.className = `text-center text-sm font-semibold transition-opacity duration-300 opacity-100 ${isError ? 'text-red-400' : 'text-green-400'}`;
            };

            // Email validation
            const validateEmail = (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(String(email).toLowerCase());
            };

            // Draggable help panel
            let isDragging = false;
            let currentX, currentY, initialX, initialY;

            helpBtn.addEventListener('click', () => {
                helpPanel.classList.remove('hidden');
                helpPanel.style.top = '20px';
                helpPanel.style.right = '20px';
            });

            closeHelpPanel.addEventListener('click', () => {
                helpPanel.classList.add('hidden');
            });

            helpPanelHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                initialX = e.clientX - (parseInt(helpPanel.style.left) || 0);
                initialY = e.clientY - (parseInt(helpPanel.style.top) || 0);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    helpPanel.style.left = currentX + 'px';
                    helpPanel.style.top = currentY + 'px';
                    helpPanel.style.right = 'auto';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // CC/BCC multi-input functionality
            const addChip = (container, email, list) => {
                const trimmedEmail = email.trim();
                if (!trimmedEmail) return false;
                
                const isValid = validateEmail(trimmedEmail);
                
                const chip = document.createElement('span');
                chip.className = `chip ${!isValid ? 'invalid' : ''}`;
                chip.innerHTML = `
                    ${trimmedEmail}
                    <button type="button">√ó</button>
                `;
                
                chip.querySelector('button').addEventListener('click', () => {
                    const index = list.indexOf(trimmedEmail);
                    if (index > -1) list.splice(index, 1);
                    chip.remove();
                    updateInvalidEmailCount();
                });
                
                container.appendChild(chip);
                list.push(trimmedEmail);
                updateInvalidEmailCount();
                
                if (!isValid) {
                    showToast(`Invalid email: ${trimmedEmail}`, 'error');
                }
                
                return true;
            };

            const updateInvalidEmailCount = () => {
                const invalidCount = document.querySelectorAll('.chip.invalid').length;
                document.getElementById('stat-invalid-emails').textContent = invalidCount;
            };

            const handleEmailInput = (input, container, list) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
                        e.preventDefault();
                        const email = input.value.trim().replace(/,/g, '');
                        if (email && addChip(container, email, list)) {
                            input.value = '';
                        }
                    } else if (e.key === 'Backspace' && input.value === '' && list.length > 0) {
                        list.pop();
                        container.lastChild.remove();
                        updateInvalidEmailCount();
                    }
                });

                input.addEventListener('blur', () => {
                    const email = input.value.trim().replace(/,/g, '');
                    if (email && addChip(container, email, list)) {
                        input.value = '';
                    }
                });
            };

            handleEmailInput(ccInput, ccChipsContainer, ccEmails);
            handleEmailInput(bccInput, bccChipsContainer, bccEmails);

            // Merge mode change handler
            const mergeModeRadios = document.querySelectorAll('input[name="mergeMode"]');
            mergeModeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    // Hide all option panels
                    sameRecipientOptions.classList.add('hidden');
                    multiRecipientOptions.classList.add('hidden');
                    
                    // Show relevant options
                    if (e.target.value === 'sameRecipient') {
                        sameRecipientOptions.classList.remove('hidden');
                    } else if (e.target.value === 'multiRecipient') {
                        multiRecipientOptions.classList.remove('hidden');
                    }
                });
            });

            // Variable detection and display
            const extractVariables = (text) => {
                const regex = /\{\{([^}]+)\}\}/g;
                const matches = [];
                let match;
                while ((match = regex.exec(text)) !== null) {
                    if (!matches.includes(match[1])) {
                        matches.push(match[1]);
                    }
                }
                return matches;
            };

            const updateVariableDisplay = () => {
                const subjectVars = extractVariables(subjectTemplateEl.value);
                const bodyVars = extractVariables(bodyTemplateEl.value);
                const allUsedVars = [...new Set([...subjectVars, ...bodyVars])];

                if (subjectVars.length === 0) {
                    subjectVarsDisplay.innerHTML = '<span class="text-gray-500 italic">No variables detected</span>';
                } else {
                    subjectVarsDisplay.innerHTML = subjectVars.map(v => 
                        `<span class="variable-badge used">{{${v}}}</span>`
                    ).join(' ');
                }

                if (bodyVars.length === 0) {
                    bodyVarsDisplay.innerHTML = '<span class="text-gray-500 italic">No variables detected</span>';
                } else {
                    bodyVarsDisplay.innerHTML = bodyVars.map(v => 
                        `<span class="variable-badge used">{{${v}}}</span>`
                    ).join(' ');
                }

                if (csvDataHeaders.length > 0) {
                    allColumnsDisplay.innerHTML = csvDataHeaders.map(header => {
                        const isUsed = allUsedVars.includes(header);
                        return `<span class="variable-badge ${isUsed ? 'used' : ''}">{{${header}}}</span>`;
                    }).join(' ');
                }

                document.getElementById('stat-vars-used').textContent = allUsedVars.length;
            };

            subjectTemplateEl.addEventListener('input', updateVariableDisplay);
            bodyTemplateEl.addEventListener('input', updateVariableDisplay);

            // Template management
            const saveTemplate = () => {
                const templateName = prompt('Enter a name for this template:');
                if (!templateName) return;

                // Get merge mode
                let mergeMode = 'none';
                if (mergeSameRecipientEl.checked) mergeMode = 'sameRecipient';
                else if (mergeMultiRecipientEl.checked) mergeMode = 'multiRecipient';

                const template = {
                    name: templateName,
                    subject: subjectTemplateEl.value,
                    body: bodyTemplateEl.value,
                    recipientColumn: recipientColEl.value,
                    nameColumn: nameColEl.value,
                    ccColumn: ccColEl.value,
                    bccColumn: bccColEl.value,
                    ccEmails: [...ccEmails],
                    bccEmails: [...bccEmails],
                    mergeMode: mergeMode,
                    multiRecipientField: multiRecipientToEl.checked ? 'to' : 'bcc',
                    // Merge formatting options
                    mergeSeparatorStyle: mergeSeparatorStyleEl.value,
                    includeEntryNumber: includeEntryNumberEl.checked,
                    addMergeSummary: addMergeSummaryEl.checked,
                    mergeSpacing: mergeSpacingEl.value,
                    timestamp: new Date().toISOString()
                };

                const templates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                templates.push(template);
                localStorage.setItem('emailTemplates', JSON.stringify(templates));

                showToast(`Template "${templateName}" saved successfully`, 'success');
            };

            const loadTemplates = () => {
                const templates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                
                if (templates.length === 0) {
                    templateList.innerHTML = '<p class="text-gray-400 text-center py-8">No saved templates</p>';
                    return;
                }

                templateList.innerHTML = templates.map((template, index) => `
                    <div class="template-card bg-gray-700 p-4 rounded-lg" data-index="${index}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-teal-300">${template.name}</h3>
                            <button class="delete-template text-red-400 hover:text-red-300" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mb-2">Subject: ${template.subject.substring(0, 50)}${template.subject.length > 50 ? '...' : ''}</p>
                        <p class="text-xs text-gray-500">${new Date(template.timestamp).toLocaleDateString()}</p>
                    </div>
                `).join('');

                // Add click handlers
                document.querySelectorAll('.template-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-template')) return;
                        const index = parseInt(card.dataset.index);
                        applyTemplate(templates[index]);
                        templateModal.classList.add('hidden');
                    });
                });

                document.querySelectorAll('.delete-template').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.index);
                        if (confirm(`Delete template "${templates[index].name}"?`)) {
                            templates.splice(index, 1);
                            localStorage.setItem('emailTemplates', JSON.stringify(templates));
                            loadTemplates();
                            showToast('Template deleted', 'info');
                        }
                    });
                });
            };

            const applyTemplate = (template) => {
                subjectTemplateEl.value = template.subject;
                bodyTemplateEl.value = template.body;
                
                // Set merge mode
                const mergeMode = template.mergeMode || 'none';
                
                // Hide all option panels first
                sameRecipientOptions.classList.add('hidden');
                multiRecipientOptions.classList.add('hidden');
                
                if (mergeMode === 'none') {
                    mergeNoneEl.checked = true;
                } else if (mergeMode === 'sameRecipient') {
                    mergeSameRecipientEl.checked = true;
                    sameRecipientOptions.classList.remove('hidden');
                    
                    // Restore merge formatting settings
                    if (template.mergeSeparatorStyle) mergeSeparatorStyleEl.value = template.mergeSeparatorStyle;
                    if (template.includeEntryNumber !== undefined) includeEntryNumberEl.checked = template.includeEntryNumber;
                    if (template.addMergeSummary !== undefined) addMergeSummaryEl.checked = template.addMergeSummary;
                    if (template.mergeSpacing) mergeSpacingEl.value = template.mergeSpacing;
                } else if (mergeMode === 'multiRecipient') {
                    mergeMultiRecipientEl.checked = true;
                    multiRecipientOptions.classList.remove('hidden');
                    
                    // Set multi-recipient field
                    if (template.multiRecipientField === 'bcc') {
                        multiRecipientBccEl.checked = true;
                    } else {
                        multiRecipientToEl.checked = true;
                    }
                }

                // Clear existing manual emails
                ccEmails.length = 0;
                bccEmails.length = 0;
                ccChipsContainer.innerHTML = '';
                bccChipsContainer.innerHTML = '';

                // Add template emails
                if (template.ccEmails) template.ccEmails.forEach(email => addChip(ccChipsContainer, email, ccEmails));
                if (template.bccEmails) template.bccEmails.forEach(email => addChip(bccChipsContainer, email, bccEmails));

                updateVariableDisplay();
                showToast(`Template "${template.name}" loaded`, 'success');
            };

            saveTemplateBtn.addEventListener('click', saveTemplate);
            loadTemplateBtn.addEventListener('click', () => {
                loadTemplates();
                templateModal.classList.remove('hidden');
            });

            closeTemplateModal.addEventListener('click', () => {
                templateModal.classList.add('hidden');
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Help panel toggle (?)
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        helpPanel.classList.toggle('hidden');
                    }
                }

                // Generate (Ctrl/Cmd + G)
                if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                    e.preventDefault();
                    generateBtn.click();
                }

                // Preview (Ctrl/Cmd + P)
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    previewBtn.click();
                }

                // Save template (Ctrl/Cmd + S)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveTemplate();
                }

                // Undo (Ctrl/Cmd + Z)
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    if (undoStack.length > 0) {
                        e.preventDefault();
                        const lastState = undoStack.pop();
                        generatedEmails = lastState.emails;
                        linksContainerEl.innerHTML = lastState.html;
                        exportSection.classList.remove('hidden');
                        document.getElementById('stat-emails-gen').textContent = generatedEmails.length;
                        showToast('Restored previous emails', 'success');
                        undoBtn.disabled = undoStack.length === 0;
                    }
                }
            });

            // Undo button
            undoBtn.addEventListener('click', () => {
                if (undoStack.length > 0) {
                    const lastState = undoStack.pop();
                    generatedEmails = lastState.emails;
                    linksContainerEl.innerHTML = lastState.html;
                    exportSection.classList.remove('hidden');
                    document.getElementById('stat-emails-gen').textContent = generatedEmails.length;
                    showToast('Restored previous emails', 'success');
                    undoBtn.disabled = undoStack.length === 0;
                }
            });

            // Preview modal handlers
            closePreviewBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
            });

            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) {
                    previewModal.classList.add('hidden');
                }
            });

            // File upload handler
            csvFileEl.addEventListener('change', () => {
                const file = csvFileEl.files[0];
                if (!file) return;
                
                showProgress(true);
                showStatus('Reading file...', false);
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv')) {
                    parseCSV(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    parseExcel(file);
                } else {
                    showStatus('Unsupported file format. Please upload CSV or Excel files.', true);
                    showProgress(false);
                }
            });

            const parseCSV = (file) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        handleParsedData(results.data, results.meta.fields, results.errors);
                    },
                    error: function(error) {
                        console.error('CSV parsing error:', error);
                        showStatus('Failed to parse CSV file. Please ensure it is a valid CSV format.', true);
                        showProgress(false);
                    }
                });
            };

            const parseExcel = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        
                        if (jsonData.length === 0) {
                            showStatus('The Excel file contains no data rows.', true);
                            showProgress(false);
                            return;
                        }
                        
                        const headers = Object.keys(jsonData[0]);
                        handleParsedData(jsonData, headers, []);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        showStatus('Failed to parse Excel file. Please ensure it is a valid format.', true);
                        showProgress(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleParsedData = (data, headers, errors) => {
                if (errors && errors.length > 0) {
                    console.error('Parsing errors:', errors);
                }
                
                if (data.length === 0) {
                    showStatus('The file contains no data rows.', true);
                    showProgress(false);
                    return;
                }
                
                csvData = data;
                csvDataHeaders = headers;
                
                if (!csvDataHeaders || csvDataHeaders.length === 0) {
                    showStatus('Could not find headers. Please ensure the first row contains column names.', true);
                    showProgress(false);
                    return;
                }

                populateHeaderTags(csvDataHeaders);
                populateDropdowns(csvDataHeaders);
                showDataPreview(data, headers);
                updateVariableDisplay();
                headersSectionEl.classList.remove('hidden');
                previewSectionEl.classList.remove('hidden');
                filterSection.classList.remove('hidden');
                statsPanel.classList.remove('hidden');
                
                document.getElementById('stat-total-rows').textContent = data.length;
                document.getElementById('stat-filtered-rows').textContent = data.length;
                
                showStatus(`‚úÖ Loaded ${data.length} rows with ${csvDataHeaders.length} columns`, false);
                showToast(`Loaded ${data.length} rows successfully`, 'success');
                showProgress(false);
            };

            const showDataPreview = (data, headers) => {
                const previewRows = data.slice(0, 3);
                rowCountEl.textContent = `Showing 3 of ${data.length} rows`;
                
                let headerHTML = '<tr>';
                headers.forEach(header => {
                    headerHTML += `<th class="text-left px-3 py-2 text-gray-300 border-b border-gray-600 whitespace-nowrap font-semibold">${header}</th>`;
                });
                headerHTML += '</tr>';
                previewTableHeadEl.innerHTML = headerHTML;
                
                let bodyHTML = '';
                previewRows.forEach(row => {
                    bodyHTML += '<tr class="border-b border-gray-600">';
                    headers.forEach(header => {
                        const value = row[header] || '';
                        const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                        bodyHTML += `<td class="px-3 py-2 text-gray-400 max-w-xs" style="min-width: 100px; max-width: 300px;">${displayValue}</td>`;
                    });
                    bodyHTML += '</tr>';
                });
                previewTableBodyEl.innerHTML = bodyHTML;
                
                // Check if table is scrollable and show hint
                setTimeout(() => {
                    const container = document.getElementById('previewTableContainer');
                    const table = document.getElementById('dataPreviewTable');
                    if (container && table) {
                        if (table.offsetWidth > container.offsetWidth) {
                            container.classList.add('show-hint');
                            setTimeout(() => container.classList.remove('show-hint'), 3000);
                        }
                    }
                }, 100);
            };

            const populateHeaderTags = (headers) => {
                headerTagsEl.innerHTML = '';
                headers.forEach(header => {
                    const tag = document.createElement('span');
                    tag.textContent = `{{${header}}}`;
                    tag.className = 'cursor-pointer bg-teal-600 hover:bg-teal-500 transition-colors duration-200 text-white text-xs font-semibold px-3 py-1.5 rounded-full';
                    tag.onclick = () => {
                        const placeholder = `{{${header}}}`;
                        navigator.clipboard.writeText(placeholder).then(() => {
                            showToast(`Copied '${placeholder}'`, 'success');
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            showToast('Failed to copy', 'error');
                        });
                    };
                    headerTagsEl.appendChild(tag);
                });
            };

            const populateDropdowns = (headers) => {
                const dropdowns = [
                    { el: recipientColEl, includeNone: false },
                    { el: nameColEl, includeNone: true },
                    { el: ccColEl, includeNone: true },
                    { el: bccColEl, includeNone: true },
                    { el: attachmentsColEl, includeNone: true }
                ];

                dropdowns.forEach(({ el, includeNone }) => {
                    el.innerHTML = includeNone ? '<option value="">None</option>' : '';
                    headers.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        el.appendChild(option);
                    });
                });

                // Auto-select email column
                const emailHeaders = headers.filter(h => 
                    h.toLowerCase().includes('email') || h.toLowerCase().includes('mail')
                );
                if (emailHeaders.length > 0) {
                    recipientColEl.value = emailHeaders[0];
                }

                // Auto-select name column
                const nameHeaders = headers.filter(h => 
                    h.toLowerCase().includes('name') || h.toLowerCase() === 'first' || h.toLowerCase() === 'firstname'
                );
                if (nameHeaders.length > 0) {
                    nameColEl.value = nameHeaders[0];
                }
            };

            // Filter functionality
            let filterIdCounter = 0;
            
            addFilterBtn.addEventListener('click', () => {
                addFilter();
            });

            const addFilter = () => {
                const filterId = filterIdCounter++;
                const filterDiv = document.createElement('div');
                filterDiv.className = 'flex flex-col sm:flex-row gap-2 items-stretch sm:items-center bg-gray-700 p-3 rounded-lg max-w-full';
                filterDiv.dataset.filterId = filterId;
                
                filterDiv.innerHTML = `
                    <select class="filter-column flex-1 p-2 rounded bg-gray-600 text-gray-100 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 min-w-0">
                        ${csvDataHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                    <select class="filter-operator p-2 rounded bg-gray-600 text-gray-100 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 sm:w-auto min-w-0">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="not_empty">Not Empty</option>
                        <option value="empty">Empty</option>
                    </select>
                    <input type="text" class="filter-value flex-1 p-2 rounded bg-gray-600 text-gray-100 text-xs md:text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500 min-w-0" placeholder="Value">
                    <button class="remove-filter p-2 bg-red-900 hover:bg-red-800 rounded text-white transition-colors flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                
                filterContainer.appendChild(filterDiv);
                
                const removeBtn = filterDiv.querySelector('.remove-filter');
                removeBtn.addEventListener('click', () => {
                    filterDiv.remove();
                    updateFilterStats();
                });
                
                const operatorSelect = filterDiv.querySelector('.filter-operator');
                const valueInput = filterDiv.querySelector('.filter-value');
                
                operatorSelect.addEventListener('change', () => {
                    if (operatorSelect.value === 'not_empty' || operatorSelect.value === 'empty') {
                        valueInput.disabled = true;
                        valueInput.value = '';
                    } else {
                        valueInput.disabled = false;
                    }
                    updateFilterStats();
                });
                
                filterDiv.querySelectorAll('select, input').forEach(el => {
                    el.addEventListener('change', updateFilterStats);
                    el.addEventListener('input', updateFilterStats);
                });
                
                updateFilterStats();
            };

            const updateFilterStats = () => {
                if (!csvData) return;
                
                const activeFilters = Array.from(filterContainer.querySelectorAll('[data-filter-id]'));
                if (activeFilters.length === 0) {
                    filterStats.classList.add('hidden');
                    document.getElementById('stat-filtered-rows').textContent = csvData.length;
                    return;
                }
                
                const filteredData = getFilteredData();
                filterStats.textContent = `${filteredData.length} of ${csvData.length} rows match filters`;
                filterStats.classList.remove('hidden');
                document.getElementById('stat-filtered-rows').textContent = filteredData.length;
            };

            const getFilteredData = () => {
                if (!csvData) return [];
                
                const activeFilters = Array.from(filterContainer.querySelectorAll('[data-filter-id]'));
                if (activeFilters.length === 0) return csvData;
                
                return csvData.filter(row => {
                    return activeFilters.every(filterDiv => {
                        const column = filterDiv.querySelector('.filter-column').value;
                        const operator = filterDiv.querySelector('.filter-operator').value;
                        const value = filterDiv.querySelector('.filter-value').value;
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        
                        switch (operator) {
                            case 'equals':
                                return cellValue === value.toLowerCase();
                            case 'contains':
                                return cellValue.includes(value.toLowerCase());
                            case 'not_empty':
                                return cellValue.trim() !== '';
                            case 'empty':
                                return cellValue.trim() === '';
                            default:
                                return true;
                        }
                    });
                });
            };

            // Template helpers
            insertGreetingBtn.addEventListener('click', () => {
                const nameCol = nameColEl.value;
                const greeting = nameCol 
                    ? `Dear {{${nameCol}}},\n\n`
                    : `Hello,\n\n`;
                const cursorPos = bodyTemplateEl.selectionStart;
                const textBefore = bodyTemplateEl.value.substring(0, cursorPos);
                const textAfter = bodyTemplateEl.value.substring(cursorPos);
                bodyTemplateEl.value = textBefore + greeting + textAfter;
                bodyTemplateEl.focus();
                updateVariableDisplay();
            });

            insertSignatureBtn.addEventListener('click', () => {
                const signature = `\n\nBest regards,\n[Your Name]`;
                const cursorPos = bodyTemplateEl.selectionStart;
                const textBefore = bodyTemplateEl.value.substring(0, cursorPos);
                const textAfter = bodyTemplateEl.value.substring(cursorPos);
                bodyTemplateEl.value = textBefore + signature + textAfter;
                bodyTemplateEl.focus();
            });

            // Preview functionality
            previewBtn.addEventListener('click', () => {
                const recipientCol = recipientColEl.value;
                const subjectTemplate = subjectTemplateEl.value;
                const bodyTemplate = bodyTemplateEl.value;
                const ccCol = ccColEl.value;
                const bccCol = bccColEl.value;

                if (!csvData || csvData.length === 0) {
                    showToast('Please upload a file first', 'error');
                    return;
                }
                if (!recipientCol) {
                    showToast('Please select a recipient column', 'error');
                    return;
                }

                const filteredData = getFilteredData();
                if (filteredData.length === 0) {
                    showToast('No rows match your filters', 'error');
                    return;
                }

                const firstRow = filteredData[0];
                const recipient = firstRow[recipientCol];
                let finalSubject = subjectTemplate;
                let finalBody = bodyTemplate;
                let ccEmail = ccCol ? (firstRow[ccCol] || '') : '';
                let bccEmail = bccCol ? (firstRow[bccCol] || '') : '';

                const allCC = [...ccEmails, ccEmail].filter(e => e).join(', ');
                const allBCC = [...bccEmails, bccEmail].filter(e => e).join(', ');

                csvDataHeaders.forEach(header => {
                    const placeholder = `{{${header}}}`;
                    const value = firstRow[header] || '';
                    finalSubject = finalSubject.split(placeholder).join(value);
                    finalBody = finalBody.split(placeholder).join(value);
                });

                document.getElementById('previewTo').textContent = recipient || '(No recipient)';
                document.getElementById('previewSubject').textContent = finalSubject || '(No subject)';
                document.getElementById('previewBody').textContent = finalBody || '(No body)';
                
                if (allCC) {
                    document.getElementById('previewCcSection').classList.remove('hidden');
                    document.getElementById('previewCc').textContent = allCC;
                } else {
                    document.getElementById('previewCcSection').classList.add('hidden');
                }
                
                if (allBCC) {
                    document.getElementById('previewBccSection').classList.remove('hidden');
                    document.getElementById('previewBcc').textContent = allBCC;
                } else {
                    document.getElementById('previewBccSection').classList.add('hidden');
                }

                previewModal.classList.remove('hidden');
            });

            // Generate functionality
            generateBtn.addEventListener('click', () => {
                const recipientCol = recipientColEl.value;
                const subjectTemplate = subjectTemplateEl.value;
                const bodyTemplate = bodyTemplateEl.value;
                const ccCol = ccColEl.value;
                const bccCol = bccColEl.value;
                const attachmentsCol = attachmentsColEl.value;
                
                // Get merge mode
                let mergeMode = 'none';
                if (mergeSameRecipientEl.checked) mergeMode = 'sameRecipient';
                else if (mergeMultiRecipientEl.checked) mergeMode = 'multiRecipient';
                
                const multiRecipientField = multiRecipientToEl.checked ? 'to' : 'bcc';

                if (!csvData) {
                    showToast('Please upload a file first', 'error');
                    return;
                }
                if (!recipientCol) {
                    showToast('Please select a recipient column', 'error');
                    return;
                }
                
                const filteredData = getFilteredData();
                if (filteredData.length === 0) {
                    showToast('No rows match your filters', 'error');
                    return;
                }

                showProgress(true);
                showStatus('Generating email drafts...', false);
                generateSpinner.classList.remove('hidden');
                generateBtn.disabled = true;

                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    linksContainerEl.innerHTML = '';
                    generatedEmails = [];

                    processAndGenerateEmails(filteredData, recipientCol, subjectTemplate, bodyTemplate, ccCol, bccCol, attachmentsCol, mergeMode, multiRecipientField);
                    
                    exportSection.classList.remove('hidden');
                    showProgress(false);
                    generateSpinner.classList.add('hidden');
                    generateBtn.disabled = false;
                }, 100);
            });

            const processAndGenerateEmails = (data, recipientCol, subjectTemplate, bodyTemplate, ccCol, bccCol, attachmentsCol, mergeMode, multiRecipientField) => {
                if (mergeMode === 'sameRecipient') {
                    // Original merge mode: combine rows with same recipient
                    const recipientGroups = {};
                    data.forEach(row => {
                        const recipient = row[recipientCol];
                        
                        if (recipient && recipient.trim()) {
                            if (!recipientGroups[recipient]) {
                                recipientGroups[recipient] = [];
                            }
                            recipientGroups[recipient].push(row);
                        }
                    });

                    let generatedCount = 0;
                    for (const recipient in recipientGroups) {
                        const rowsForRecipient = recipientGroups[recipient];
                        let mergedBody = '';
                        let allCCs = new Set(ccEmails);
                        let allBCCs = new Set(bccEmails);
                        let allAttachments = new Set();
                        let firstSubject = '';
                        let firstRowVariables = {}; 

                        // Get merge formatting options
                        const separatorStyle = mergeSeparatorStyleEl.value;
                        const includeEntryNumber = includeEntryNumberEl.checked;
                        const addSummary = addMergeSummaryEl.checked;
                        const spacing = mergeSpacingEl.value;
                        
                        // Determine line breaks based on spacing
                        const lineBreaks = spacing === 'single' ? '\n' : spacing === 'double' ? '\n\n' : '\n\n\n';

                        // Add summary at top if requested
                        if (addSummary && rowsForRecipient.length > 1) {
                            mergedBody += `You have ${rowsForRecipient.length} items below:\n\n`;
                        }

                        rowsForRecipient.forEach((row, idx) => {
                            let finalSubject = subjectTemplate;
                            let finalBody = bodyTemplate;
                            
                            const variables = {};
                            csvDataHeaders.forEach(header => {
                                const placeholder = `{{${header}}}`;
                                const value = row[header] || '';
                                finalSubject = finalSubject.split(placeholder).join(value);
                                finalBody = finalBody.split(placeholder).join(value);
                                variables[header] = value;
                            });

                            if (idx === 0) {
                                firstSubject = finalSubject;
                                firstRowVariables = variables;
                            }

                            // Build separator based on style
                            let separator = '';
                            if (separatorStyle !== 'none') {
                                if (separatorStyle === 'numbered') {
                                    separator = includeEntryNumber ? `--- Entry ${idx + 1} ---\n` : '---\n';
                                } else if (separatorStyle === 'bullets') {
                                    separator = includeEntryNumber ? `‚Ä¢ Item ${idx + 1}\n` : '‚Ä¢\n';
                                } else if (separatorStyle === 'headers') {
                                    separator = includeEntryNumber ? `== ENTRY ${idx + 1} ==\n` : '==\n';
                                } else if (separatorStyle === 'simple') {
                                    separator = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                                }
                            }

                            mergedBody += separator + finalBody + lineBreaks;
                            
                            if (ccCol && row[ccCol]) allCCs.add(row[ccCol]);
                            if (bccCol && row[bccCol]) allBCCs.add(row[bccCol]);
                            if (attachmentsCol && row[attachmentsCol]) allAttachments.add(row[attachmentsCol]);
                        });

                        const ccEmailsFinal = Array.from(allCCs).join(', ');
                        const bccEmailsFinal = Array.from(allBCCs).join(', ');
                        const attachments = Array.from(allAttachments).join(', ');
                        
                        createEmailOutputBlock(recipient, firstSubject, mergedBody, ccEmailsFinal, bccEmailsFinal, attachments, firstRowVariables, 'sameRecipient', rowsForRecipient.length);
                        generatedCount++;
                    }

                    showStatus(`‚úÖ Generated ${generatedCount} merged email drafts from ${data.length} rows`, false);
                    showToast(`Generated ${generatedCount} merged emails`, 'success');
                    document.getElementById('stat-emails-gen').textContent = generatedCount;
                    
                } else if (mergeMode === 'multiRecipient') {
                    // New mode: combine multiple recipients, single body
                    const allRecipients = [];
                    const allCCs = new Set(ccEmails);
                    const allBCCs = new Set(bccEmails);
                    const allAttachments = new Set();
                    let finalSubject = subjectTemplate;
                    let finalBody = bodyTemplate;
                    let firstRowVariables = {};

                    data.forEach((row, idx) => {
                        const recipient = row[recipientCol];
                        if (recipient && recipient.trim()) {
                            allRecipients.push(recipient);
                        }

                        // Use first row for variable substitution
                        if (idx === 0) {
                            const variables = {};
                            csvDataHeaders.forEach(header => {
                                const placeholder = `{{${header}}}`;
                                const value = row[header] || '';
                                finalSubject = finalSubject.split(placeholder).join(value);
                                finalBody = finalBody.split(placeholder).join(value);
                                variables[header] = value;
                            });
                            firstRowVariables = variables;
                        }

                        // Collect CC, BCC, and attachments
                        if (ccCol && row[ccCol]) allCCs.add(row[ccCol]);
                        if (bccCol && row[bccCol]) allBCCs.add(row[bccCol]);
                        if (attachmentsCol && row[attachmentsCol]) allAttachments.add(row[attachmentsCol]);
                    });

                    if (allRecipients.length > 0) {
                        let primaryRecipient, additionalRecipients;
                        let ccEmailsFinal = Array.from(allCCs).join(', ');
                        let bccEmailsFinal = Array.from(allBCCs).join(', ');

                        if (multiRecipientField === 'to') {
                            // All recipients in TO field
                            primaryRecipient = allRecipients.join(', ');
                            additionalRecipients = '';
                        } else {
                            // First in TO, rest in BCC
                            primaryRecipient = allRecipients[0];
                            const additionalBcc = allRecipients.slice(1).join(', ');
                            bccEmailsFinal = bccEmailsFinal ? `${bccEmailsFinal}, ${additionalBcc}` : additionalBcc;
                            additionalRecipients = allRecipients.slice(1);
                        }

                        const attachments = Array.from(allAttachments).join(', ');
                        
                        createEmailOutputBlock(primaryRecipient, finalSubject, finalBody, ccEmailsFinal, bccEmailsFinal, attachments, firstRowVariables, 'multiRecipient', data.length, additionalRecipients);
                        
                        showStatus(`‚úÖ Generated 1 email with ${allRecipients.length} recipients from ${data.length} rows`, false);
                        showToast(`Generated 1 email with ${allRecipients.length} recipients`, 'success');
                        document.getElementById('stat-emails-gen').textContent = '1';
                    }
                    
                } else {
                    // No merge: one email per row
                    let generatedCount = 0;
                    data.forEach(row => {
                        const recipient = row[recipientCol];

                        if (recipient && recipient.trim()) {
                            let finalSubject = subjectTemplate;
                            let finalBody = bodyTemplate;
                            let ccEmail = ccCol ? (row[ccCol] || '') : '';
                            let bccEmail = bccCol ? (row[bccCol] || '') : '';
                            let attachments = attachmentsCol ? (row[attachmentsCol] || '') : '';

                            const allCC = [...ccEmails, ccEmail].filter(e => e).join(', ');
                            const allBCC = [...bccEmails, bccEmail].filter(e => e).join(', ');

                            const variables = {};
                            csvDataHeaders.forEach(header => {
                                const placeholder = `{{${header}}}`;
                                const value = row[header] || '';
                                finalSubject = finalSubject.split(placeholder).join(value);
                                finalBody = finalBody.split(placeholder).join(value);
                                variables[header] = value;
                            });
                            
                            createEmailOutputBlock(recipient, finalSubject, finalBody, allCC, allBCC, attachments, variables, 'none', 1);
                            generatedCount++;
                        }
                    });

                    if (generatedCount > 0) {
                        showStatus(`‚úÖ Generated ${generatedCount} email drafts`, false);
                        showToast(`Generated ${generatedCount} emails`, 'success');
                        document.getElementById('stat-emails-gen').textContent = generatedCount;
                    } else {
                        showStatus('No valid rows found to generate emails.', true);
                        showToast('No valid rows found', 'error');
                    }
                }
            };
            
            const createEmailOutputBlock = (recipient, subject, body, cc, bcc, attachments, variables, mergeMode = 'none', rowCount = 1, additionalRecipients = null) => {
                const encodedSubject = encodeURIComponent(subject || '');
                const encodedBody = encodeURIComponent(body || '');
                let mailtoHref = `mailto:${recipient}?subject=${encodedSubject}&body=${encodedBody}`;
                
                if (cc) mailtoHref += `&cc=${encodeURIComponent(cc)}`;
                if (bcc) mailtoHref += `&bcc=${encodeURIComponent(bcc)}`;

                generatedEmails.push({
                    recipient,
                    subject,
                    body,
                    cc,
                    bcc,
                    attachments,
                    mailtoHref
                });

                const blockContainerEl = document.createElement('div');
                blockContainerEl.className = "space-y-2";

                const headerRow = document.createElement('div');
                headerRow.className = "flex items-center gap-2";

                const linkEl = document.createElement('a');
                linkEl.href = mailtoHref;
                linkEl.className = "flex-grow block bg-gray-700 hover:bg-gray-600 transition-colors duration-200 p-4 rounded-lg text-sm text-left shadow-md";
                
                let linkContent = `<span class="font-bold text-teal-300">To:</span> ${recipient}`;
                
                if (mergeMode === 'sameRecipient') {
                    linkContent += `<br><span class="font-bold text-amber-300">üìã Merged:</span> ${rowCount} entries combined`;
                } else if (mergeMode === 'multiRecipient') {
                    linkContent += `<br><span class="font-bold text-purple-300">üë• Multi-recipient:</span> ${rowCount} recipients total`;
                    if (additionalRecipients && additionalRecipients.length > 0) {
                        linkContent += `<br><span class="text-xs text-gray-400">+ ${additionalRecipients.length} more in BCC</span>`;
                    }
                }
                
                if (cc) linkContent += `<br><span class="font-bold text-sky-300">CC:</span> ${cc}`;
                if (bcc) linkContent += `<br><span class="font-bold text-purple-300">BCC:</span> ${bcc}`;
                linkContent += `<br><span class="font-bold text-sky-300">Subject:</span> ${subject || '(No subject)'}`;
                if (attachments) linkContent += `<br><span class="font-bold text-rose-300">üìé Remember to attach:</span> ${attachments}`;

                linkEl.innerHTML = linkContent;

                linkEl.addEventListener('click', () => {
                    if (!linkEl.dataset.clicked) {
                        linkEl.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        linkEl.classList.add('bg-green-800', 'text-green-200');
                        linkEl.innerHTML += ' <span class="text-green-300 text-lg">‚úì Opened</span>';
                        linkEl.dataset.clicked = 'true';
                    }
                });

                const copyButton = document.createElement('button');
                copyButton.className = "shrink-0 p-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg shadow-md";
                copyButton.title = "Copy mailto link";
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 2a2 2 0 00-2 2v2H4a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-2h2a2 2 0 002-2V8a2 2 0 00-2-2h-2V4a2 2 0 00-2-2h-4z" />
                </svg>`;
                copyButton.onclick = () => {
                    navigator.clipboard.writeText(mailtoHref).then(() => {
                        showToast('Copied mailto link', 'success');
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        showToast('Failed to copy link', 'error');
                    });
                };
                
                const variablesToggleBtn = document.createElement('button');
                variablesToggleBtn.className = "shrink-0 p-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg shadow-md";
                variablesToggleBtn.title = "Show variables";
                variablesToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>`;
                
                const variablesContainer = document.createElement('div');
                variablesContainer.className = "hidden pl-4 pr-2 pb-2 text-xs text-gray-400 overflow-x-auto bg-gray-750 rounded p-3 mt-2";
                let varsHtml = `<p class="font-bold text-gray-300 mb-2">${mergeMode === 'sameRecipient' ? 'Variables (first entry):' : 'Variables:'}</p>`;
                for (const key in variables) {
                    if (variables.hasOwnProperty(key)) {
                        varsHtml += `<p class="mb-1"><span class="font-semibold text-gray-300">${key}:</span> ${variables[key]}</p>`;
                    }
                }
                variablesContainer.innerHTML = varsHtml;

                variablesToggleBtn.onclick = () => {
                    variablesContainer.classList.toggle('hidden');
                    variablesToggleBtn.querySelector('svg').classList.toggle('rotate-180');
                };
                
                headerRow.appendChild(linkEl);
                headerRow.appendChild(copyButton);
                headerRow.appendChild(variablesToggleBtn);
                
                blockContainerEl.appendChild(headerRow);
                blockContainerEl.appendChild(variablesContainer);

                linksContainerEl.appendChild(blockContainerEl);
            };

            // Export functionality
            exportMailtoBtn.addEventListener('click', () => {
                if (generatedEmails.length === 0) {
                    showToast('No emails to export', 'error');
                    return;
                }

                let content = 'Bulk Email Export\n';
                content += '='.repeat(50) + '\n\n';
                
                generatedEmails.forEach((email, index) => {
                    content += `Email ${index + 1}\n`;
                    content += `-`.repeat(30) + '\n';
                    content += `To: ${email.recipient}\n`;
                    if (email.cc) content += `CC: ${email.cc}\n`;
                    if (email.bcc) content += `BCC: ${email.bcc}\n`;
                    content += `Subject: ${email.subject}\n`;
                    if (email.attachments) content += `Attachments: ${email.attachments}\n`;
                    content += `\nMailto Link:\n${email.mailtoHref}\n`;
                    content += `\nBody:\n${email.body}\n`;
                    content += '\n' + '='.repeat(50) + '\n\n';
                });

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `email-drafts-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Exported to TXT file', 'success');
            });

            exportCsvBtn.addEventListener('click', () => {
                if (generatedEmails.length === 0) {
                    showToast('No emails to export', 'error');
                    return;
                }

                const csvHeaders = ['To', 'CC', 'BCC', 'Subject', 'Body', 'Attachments', 'Mailto Link'];
                const csvRows = generatedEmails.map(email => [
                    email.recipient,
                    email.cc || '',
                    email.bcc || '',
                    email.subject,
                    email.body,
                    email.attachments || '',
                    email.mailtoHref
                ]);

                const csv = Papa.unparse({
                    fields: csvHeaders,
                    data: csvRows
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `email-drafts-${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Exported to CSV file', 'success');
            });

            clearAllBtn.addEventListener('click', () => {
                if (confirm('Clear all generated emails? This cannot be undone.')) {
                    // Save to undo stack
                    undoStack.push({
                        emails: [...generatedEmails],
                        html: linksContainerEl.innerHTML
                    });
                    if (undoStack.length > 10) undoStack.shift(); // Keep only last 10 states
                    undoBtn.disabled = false;

                    linksContainerEl.innerHTML = '';
                    generatedEmails = [];
                    exportSection.classList.add('hidden');
                    document.getElementById('stat-emails-gen').textContent = '0';
                    showToast('Cleared all emails (Ctrl+Z to undo)', 'info');
                }
            });
        });
    </script>

</body>
</html>
