<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 antialiased leading-relaxed">

    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 text-gray-200 p-8 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-500 ease-in-out hover:scale-[1.01]">
            <h1 class="text-4xl font-extrabold text-teal-400 mb-2 text-center">Bulk Email Creator</h1>
            <p class="text-sm text-gray-400 mb-6 text-center">Generate multiple Outlook draft emails from a CSV file.</p>
            
            <div class="space-y-6">
                <div>
                    <label for="csvFile" class="block text-sm font-medium text-gray-300 mb-2">1. Upload your CSV file</label>
                    <input type="file" id="csvFile" accept=".csv" class="w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-teal-500 file:text-white
                        hover:file:bg-teal-600 transition-colors duration-200 cursor-pointer">
                </div>

                <div id="headers-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">2. Available Headers (Click to copy)</label>
                    <div id="headerTags" class="flex flex-wrap gap-2 mb-4 p-3 bg-gray-700 rounded-lg">
                        </div>
                </div>

                <div>
                    <label for="recipientColumn" class="block text-sm font-medium text-gray-300 mb-2">3. Select Recipient Column</label>
                    <select id="recipientColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
                </div>
                
                <div>
                    <label for="subjectTemplate" class="block text-sm font-medium text-gray-300 mb-2">4. Enter Email Subject</label>
                    <input type="text" id="subjectTemplate" placeholder="e.g., Your monthly update from {{Company}}" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>

                <div>
                    <label for="bodyTemplate" class="block text-sm font-medium text-gray-300 mb-2">5. Enter Email Body</label>
                    <textarea id="bodyTemplate" rows="8" placeholder="e.g., Dear {{Name}},&#10;&#10;Your account number {{AccountNumber}} is now ready.&#10;&#10;Best regards,&#10;The Team" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label for="ccColumn" class="block text-sm font-medium text-gray-300 mb-2">6. CC Column (Optional)</label>
                        <select id="ccColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div>
                        <label for="bccColumn" class="block text-sm font-medium text-gray-300 mb-2">7. BCC Column (Optional)</label>
                        <select id="bccColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div>
                        <label for="attachmentsColumn" class="block text-sm font-medium text-gray-300 mb-2">8. Attachments Column (Optional)</label>
                        <select id="attachmentsColumn" class="w-full p-2.5 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-3 p-3 bg-gray-700 rounded-lg">
                    <input type="checkbox" id="mergeEmails" class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-teal-500 focus:ring-2 focus:ring-teal-500">
                    <label for="mergeEmails" class="text-sm text-gray-300">
                        <span class="font-semibold">Merge multiple rows per recipient</span>
                        <span class="block text-xs text-gray-400 mt-1">Combine emails to the same recipient into one email with numbered sections</span>
                    </label>
                </div>

                <button id="generateBtn" class="w-full py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                    Generate Email Drafts
                </button>
            </div>

            <div id="statusMessage" class="mt-6 text-center text-sm font-semibold transition-opacity duration-300 opacity-0"></div>
            
            <div id="emailLinksContainer" class="mt-8 space-y-3 pr-2">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const csvFileEl = document.getElementById('csvFile');
            const headersSectionEl = document.getElementById('headers-section');
            const headerTagsEl = document.getElementById('headerTags');
            const recipientColEl = document.getElementById('recipientColumn');
            const subjectTemplateEl = document.getElementById('subjectTemplate');
            const bodyTemplateEl = document.getElementById('bodyTemplate');
            const ccColEl = document.getElementById('ccColumn');
            const bccColEl = document.getElementById('bccColumn');
            const attachmentsColEl = document.getElementById('attachmentsColumn');
            const mergeEmailsEl = document.getElementById('mergeEmails');
            const generateBtn = document.getElementById('generateBtn');
            const statusMessageEl = document.getElementById('statusMessage');
            const linksContainerEl = document.getElementById('emailLinksContainer');

            let csvDataHeaders = [];

            const showStatus = (message, isError = false) => {
                statusMessageEl.textContent = message;
                statusMessageEl.className = `mt-6 text-center text-sm font-semibold transition-opacity duration-300 opacity-100 ${isError ? 'text-red-400' : 'text-green-400'}`;
            };

            csvFileEl.addEventListener('change', () => {
                const file = csvFileEl.files[0];
                if (!file) {
                    return;
                }
                
                showStatus('Reading file...', false);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    processHeaders(text);
                };
                reader.readAsText(file);
            });

            const processHeaders = (text) => {
                // Corrected to handle the standard Excel CSV behavior of using quotes for fields with commas/newlines
                // However, without a dedicated CSV parser, we'll stick to a basic split and assume clean CSV for simplicity,
                // but we should advise the user that the CSV should not contain commas within fields if this basic parser is used.
                const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                if (rows.length === 0) {
                    showStatus('The CSV file is empty.', true);
                    return;
                }
                
                // Simple split. For robust app, use PapaParse or similar.
                csvDataHeaders = rows[0].split(',').map(h => h.trim());
                if (csvDataHeaders.length === 0 || !csvDataHeaders[0]) {
                    showStatus('Could not find headers in the CSV. Please ensure the first row is a header.', true);
                    return;
                }

                populateHeaderTags(csvDataHeaders);
                populateDropdowns(csvDataHeaders);
                headersSectionEl.classList.remove('hidden');
                showStatus(`Found ${csvDataHeaders.length} headers. You can now create your template.`, false);
            };

            const populateHeaderTags = (headers) => {
                headerTagsEl.innerHTML = '';
                headers.forEach(header => {
                    const tag = document.createElement('span');
                    tag.textContent = `{{${header}}}`;
                    tag.className = 'cursor-pointer bg-teal-600 hover:bg-teal-500 transition-colors duration-200 text-white text-xs font-semibold px-3 py-1 rounded-full';
                    tag.onclick = () => {
                        const placeholder = `{{${header}}}`;
                        const tempTextarea = document.createElement('textarea');
                        tempTextarea.value = placeholder;
                        document.body.appendChild(tempTextarea);
                        tempTextarea.select();
                        try {
                            document.execCommand('copy');
                            showStatus(`Copied '${placeholder}' to clipboard.`, false);
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            showStatus('Failed to copy placeholder. Please copy manually.', true);
                        } finally {
                            document.body.removeChild(tempTextarea);
                        }
                    };
                    headerTagsEl.appendChild(tag);
                });
            };

            const populateDropdowns = (headers) => {
                // Populate recipient dropdown
                recipientColEl.innerHTML = '';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    recipientColEl.appendChild(option);
                });

                // Populate CC dropdown
                ccColEl.innerHTML = '<option value="">None</option>';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    ccColEl.appendChild(option);
                });

                // Populate BCC dropdown
                bccColEl.innerHTML = '<option value="">None</option>';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    bccColEl.appendChild(option);
                });

                // Populate Attachments dropdown
                attachmentsColEl.innerHTML = '<option value="">None</option>';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    attachmentsColEl.appendChild(option);
                });
            };
            
            generateBtn.addEventListener('click', () => {
                const file = csvFileEl.files[0];
                const recipientCol = recipientColEl.value;
                const subjectTemplate = subjectTemplateEl.value;
                const bodyTemplate = bodyTemplateEl.value;
                const ccCol = ccColEl.value;
                const bccCol = bccColEl.value;
                const attachmentsCol = attachmentsColEl.value;
                const shouldMerge = mergeEmailsEl.checked;

                if (!file) {
                    showStatus('Please upload a CSV file first.', true);
                    return;
                }
                if (!recipientCol) {
                    showStatus('Please select a recipient column.', true);
                    return;
                }
                
                showStatus('Generating email drafts...', false);
                linksContainerEl.innerHTML = '';

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    processAndGenerateEmails(text, recipientCol, subjectTemplate, bodyTemplate, ccCol, bccCol, attachmentsCol, shouldMerge);
                };
                reader.readAsText(file);
            });

            const processAndGenerateEmails = (text, recipientCol, subjectTemplate, bodyTemplate, ccCol, bccCol, attachmentsCol, shouldMerge) => {
                const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                if (rows.length <= 1) {
                    showStatus('The CSV file contains no data rows.', true);
                    return;
                }
                
                const headers = rows[0].split(',').map(h => h.trim());
                const recipientIndex = headers.indexOf(recipientCol);
                const ccIndex = ccCol ? headers.indexOf(ccCol) : -1;
                const bccIndex = bccCol ? headers.indexOf(bccCol) : -1;
                const attachmentsIndex = attachmentsCol ? headers.indexOf(attachmentsCol) : -1;

                if (recipientIndex === -1) {
                    showStatus(`Recipient column '${recipientCol}' was not found in the CSV.`, true);
                    return;
                }

                if (shouldMerge) {
                    // Group rows by recipient
                    const recipientGroups = {};
                    for (let i = 1; i < rows.length; i++) {
                        const rowData = rows[i].split(',');
                        const recipient = rowData[recipientIndex];
                        
                        if (recipient) {
                            if (!recipientGroups[recipient]) {
                                recipientGroups[recipient] = [];
                            }
                            recipientGroups[recipient].push(rowData);
                        }
                    }

                    let generatedCount = 0;
                    for (const recipient in recipientGroups) {
                        const rowsForRecipient = recipientGroups[recipient];
                        let mergedBody = '';
                        let allCCs = new Set();
                        let allBCCs = new Set();
                        let allAttachments = new Set();
                        let firstSubject = '';
                        // allVariables will hold the variables of the first row for display in the variables container
                        let firstRowVariables = {}; 

                        rowsForRecipient.forEach((rowData, idx) => {
                            let finalSubject = subjectTemplate;
                            let finalBody = bodyTemplate;
                            
                            const variables = {};
                            headers.forEach((header, index) => {
                                const placeholder = `{{${header}}}`;
                                const value = rowData[index] || '';
                                finalSubject = finalSubject.split(placeholder).join(value);
                                finalBody = finalBody.split(placeholder).join(value);
                                variables[header] = value;
                            });

                            if (idx === 0) {
                                firstSubject = finalSubject;
                                firstRowVariables = variables; // Save for display
                            }

                            mergedBody += `--- Entry ${idx + 1} ---\n${finalBody}\n\n`;
                            
                            if (ccIndex !== -1 && rowData[ccIndex]) allCCs.add(rowData[ccIndex]);
                            if (bccIndex !== -1 && rowData[bccIndex]) allBCCs.add(rowData[bccIndex]);
                            if (attachmentsIndex !== -1 && rowData[attachmentsIndex]) allAttachments.add(rowData[attachmentsIndex]);
                        });

                        const ccEmails = Array.from(allCCs).join(', ');
                        const bccEmails = Array.from(allBCCs).join(', ');
                        const attachments = Array.from(allAttachments).join(', ');
                        
                        createEmailOutputBlock(recipient, firstSubject, mergedBody, ccEmails, bccEmails, attachments, firstRowVariables, true, rowsForRecipient.length);
                        generatedCount++;
                    }

                    showStatus(`Successfully merged and generated ${generatedCount} email draft links (${rows.length - 1} rows combined). Click a link to open it in Outlook, or click the copy button to copy the link.`, false);
                } else {
                    // Original behavior - one email per row
                    let generatedCount = 0;
                    for (let i = 1; i < rows.length; i++) {
                        const rowData = rows[i].split(',');
                        const recipient = rowData[recipientIndex];

                        if (recipient) {
                            let finalSubject = subjectTemplate;
                            let finalBody = bodyTemplate;
                            let ccEmail = ccIndex !== -1 ? (rowData[ccIndex] || '') : '';
                            let bccEmail = bccIndex !== -1 ? (rowData[bccIndex] || '') : '';
                            let attachments = attachmentsIndex !== -1 ? (rowData[attachmentsIndex] || '') : '';

                            const variables = {}; // Variables specific to this row
                            headers.forEach((header, index) => {
                                const placeholder = `{{${header}}}`;
                                const value = rowData[index] || '';
                                finalSubject = finalSubject.split(placeholder).join(value);
                                finalBody = finalBody.split(placeholder).join(value);
                                variables[header] = value; // Store variables for this row
                            });
                            
                            // *** FIX: Call the output block function ***
                            createEmailOutputBlock(recipient, finalSubject, finalBody, ccEmail, bccEmail, attachments, variables, false, 1);
                            generatedCount++;
                        }
                    }

                    if (generatedCount > 0) {
                        showStatus(`Successfully generated ${generatedCount} email draft links. Click a link to open it in Outlook, or click the copy button to copy the link.`, false);
                    } else {
                        showStatus('No valid rows found to generate emails.', true);
                    }
                }
            };
            
            // *** FIX: Consolidated function to create both single and merged email output blocks ***
            const createEmailOutputBlock = (recipient, subject, body, cc, bcc, attachments, variables, isMerged = false, rowCount = 1) => {
                const encodedSubject = encodeURIComponent(subject || '');
                const encodedBody = encodeURIComponent(body || '');
                let mailtoHref = `mailto:${recipient}?subject=${encodedSubject}&body=${encodedBody}`;
                
                if (cc) {
                    mailtoHref += `&cc=${encodeURIComponent(cc)}`;
                }
                if (bcc) {
                    mailtoHref += `&bcc=${encodeURIComponent(bcc)}`;
                }

                const blockContainerEl = document.createElement('div');
                blockContainerEl.className = "space-y-2";

                const headerRow = document.createElement('div');
                headerRow.className = "flex items-center gap-2";

                const linkEl = document.createElement('a');
                linkEl.href = mailtoHref;
                linkEl.className = "flex-grow block bg-gray-700 hover:bg-gray-600 transition-colors duration-200 p-3 rounded-lg text-sm text-left shadow-sm";
                
                let linkContent = `<span class="font-bold text-teal-300">To:</span> ${recipient}`;
                if (isMerged) {
                    linkContent += `<br><span class="font-bold text-amber-300">Merged Entries:</span> ${rowCount}`;
                }
                if (cc) linkContent += `<br><span class="font-bold text-sky-300">CC:</span> ${cc}`;
                if (bcc) linkContent += `<br><span class="font-bold text-purple-300">BCC:</span> ${bcc}`;
                linkContent += `<br><span class="font-bold text-sky-300">Subject:</span> ${subject || 'No Subject'}`;
                if (attachments) linkContent += `<br><span class="font-bold text-rose-300">Attachments (Manual):</span> ${attachments}`;

                linkEl.innerHTML = linkContent;

                linkEl.addEventListener('click', (e) => {
                    // Only change color/add checkmark if it's the first time being clicked
                    if (!linkEl.dataset.clicked) {
                        linkEl.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                        linkEl.classList.add('bg-green-800', 'text-green-200');

                        const checkmarkIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        checkmarkIcon.setAttribute("class", "inline-block h-4 w-4 ml-2 text-green-200");
                        checkmarkIcon.setAttribute("fill", "currentColor");
                        checkmarkIcon.setAttribute("viewBox", "0 0 20 20");
                        checkmarkIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />`;
                        linkEl.appendChild(checkmarkIcon);
                        linkEl.dataset.clicked = 'true';
                    }
                });

                const copyButton = document.createElement('button');
                copyButton.className = "shrink-0 p-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg text-sm shadow-sm";
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 2a2 2 0 00-2 2v2H4a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-2h2a2 2 0 002-2V8a2 2 0 00-2-2h-2V4a2 2 0 00-2-2h-4zM6 4a.5.5 0 01.5-.5h4a.5.5 0 01.5.5v2.5a.5.5 0 01-.5.5h-4a.5.5 0 01-.5-.5V4zm5 9H9a1 1 0 00-1 1v2a1 1 0 002 0v-2a1 1 0 00-1-1zm-1-6V8a2 2 0 002 2h2v4H8V7z" />
                </svg>`;
                copyButton.onclick = () => {
                    copyToClipboard(mailtoHref);
                    showStatus('Copied mailto link to clipboard!', false);
                };
                
                const variablesToggleBtn = document.createElement('button');
                variablesToggleBtn.className = "shrink-0 p-3 bg-gray-700 hover:bg-gray-600 transition-colors duration-200 rounded-lg text-sm shadow-sm";
                variablesToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>`;
                
                const variablesContainer = document.createElement('div');
                variablesContainer.className = "hidden pl-4 pr-2 pb-2 text-xs text-gray-400 overflow-x-auto";
                let varsHtml = '<p class="font-bold text-gray-300 mb-1">Variables used:</p>';
                // *** FIX: Use the 'variables' object passed in (which is the single row's or the first row's in a merge) ***
                for (const key in variables) {
                    if (variables.hasOwnProperty(key)) {
                        varsHtml += `<p><span class="font-semibold text-gray-300">${key}:</span> ${variables[key]}</p>`;
                    }
                }
                variablesContainer.innerHTML = varsHtml;

                variablesToggleBtn.onclick = () => {
                    variablesContainer.classList.toggle('hidden');
                    variablesToggleBtn.querySelector('svg').classList.toggle('rotate-180');
                };
                
                headerRow.appendChild(linkEl);
                headerRow.appendChild(copyButton);
                headerRow.appendChild(variablesToggleBtn);
                
                blockContainerEl.appendChild(headerRow);
                blockContainerEl.appendChild(variablesContainer);

                linksContainerEl.appendChild(blockContainerEl);
            };

            // Remove the duplicate function from the original code that only handled merged emails
            // const createMergedEmailOutputBlock = (recipient, subject, body, cc, bcc, attachments, allVariables) => { ... }


            const copyToClipboard = (text) => {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                } finally {
                    document.body.removeChild(tempTextarea);
                }
            };
        });
    </script>

</body>
</html>
